---
title: "Hurricane Effects on Stream Chemistry"
format: html
execute: 
  echo: true
  warning: false
  message: false
---

# Background

A study (Schaefer et al. 2000) investigated the effects of stream water quality in five streams in Puerto Rico after the 1989 Hurricane Hugo. They analyzed the level of nutrients over time and found that potassium levels stayed elevated for years afterwards.

## Data

Load relevant libraries and source data.

```{r}
library(here)
source(here("1_clean_data.R"))
source(here("2_processing_data.R"))
source(here("R", "rolling_mean_function.R"))
source(here("3_ggplot.R"))
```

Import the data.

```{r}
bq1 <- read_csv(here::here("data", 
                           "stream-water-pr",
                           "QuebradaCuenca1-Bisley.csv")) %>% 
  clean_names() 

bq2 <- read_csv(here::here("data", 
                           "stream-water-pr",
                           "QuebradaCuenca2-Bisley.csv")) %>% 
  clean_names()


bq3 <- read_csv(here::here("data", 
                           "stream-water-pr",
                           "QuebradaCuenca3-Bisley.csv")) %>% 
  clean_names() 


mpr <- read_csv(here::here("data", 
                           "stream-water-pr",
                           "RioMameyesPuenteRoto.csv")) %>% 
  clean_names() 
```

# Methods

## 1. Clean raw data files

The data cleaning process was as follows: 1. Loading in raw data. 2. Clean names: changing the names from upper case to lower-snake-case. 3. Filter data by only relevant chemicals/nutrients in the study. 4. Combine dataframes into one. 5. Pivot dataset and remove NAs.

```{r}
write_csv(bq1, here("outputs", "bq1_clean.csv"))
write_csv(bq2, here("outputs", "bq2_clean.csv"))
write_csv(bq3, here("outputs", "bq3_clean.csv"))
write_csv(mpr, here("outputs", "mpr_clean.csv"))
```

## 2. Filter data

After the data cleaning process, I further processed the data by filtering data by relevant chemical and filtering by time frame of study (1988-1994) and pivotted the data frame.

```{r}
source(here("R", "2_processing_data.R"))

# Filter data by only relevant chemicals/nutrients in the study (k, no3_n, mg, ca, nh4_n). 

bq1_chemicals <- bq1 %>%
  select(sample_id,sample_date, k, no3_n, mg, ca, nh4_n)  

bq2_chemicals <- bq2 %>% 
  select(sample_id, sample_date, k, no3_n, mg, ca, nh4_n)

bq3_chemicals <- bq3 %>% 
  select(sample_id, sample_date, k, no3_n, mg, ca, nh4_n)

mpr_chemicals <- mpr %>% 
  select(sample_id, sample_date, k, no3_n, mg, ca, nh4_n)

 # Filter stream data to reflect the study time frame from 1988 to 1994. 
streams <- streams %>% 
  filter((sample_date >= "1988-01-10" & sample_date < "1994-07-31"))

  # Pivot dataset from wider to longer. 
streams_longer <- streams %>%  
  pivot_longer(cols = c(k, mg, ca, nh4_n, no3_n), names_to = "chemical", 
               values_to = "chem_conc") 
 
```

## 3. Join datasets

After filtering, I combined datasets.

```{r}
streams <- rbind(bq1_chemicals, bq2_chemicals, bq3_chemicals, mpr_chemicals)
```

Apply rolling mean function.

```{r}
source(here("R", "1_clean_data.R"))
source(here("R", "2_processing_data.R"))
streams <- read_csv(here("outputs", "streams.csv"))

source(here("R", "rolling_mean_function.R"))

rolling_avg <- #Store as new data frame called "rolling_avg"
  streams_longer %>% 
  group_by(sample_id, chemical) %>% #Group dataframe by sample_id and chemical
  mutate(rolling_avg = sapply(sample_date, rolling_mean, dates = sample_date, conc = chem_conc, win_size_wks = 9)) 

```

View data.

```{r}
rolling_avg %>% 
  slice(1:100) %>% 
kable(col.names = c("sample ID", "date", "chemical", "chemical concentration", 
                    "rolling average")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE) %>%
kable_classic() %>%
  scroll_box(height = "300px", width = "700px")
```

## Results
Plot results.
```{r}
#Plot
stream_chemistry_plot <- ggplot(data = rolling_avg, aes(x = sample_date, y = rolling_avg)) + 
  
  geom_line(aes(color = sample_id)) +
  
  facet_wrap(~chemical, scales = "free_y", nrow = 5) +
  #add line for hurricane Hugo disturbance 
  geom_vline(xintercept = as.Date("1989-09-18"), linetype = "dashed", color = "black") + 
  
  labs( x = "Years", 
        y = "Concentration", 
        title = "Hurricane Effects on Stream Chemistry") +
  theme_minimal() +
  theme(legend.title = element_blank()) 

stream_chemistry_plot
```

